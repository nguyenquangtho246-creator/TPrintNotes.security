<script>
(()=>{

const $=e=>document.querySelector(e);

window.cmd=e=>document.execCommand(e,false,null);

window.showLink=()=>$("#linkBox").style.display="block";

window.insertLink=()=>{
  let t=linkText.value.trim();
  let u=linkUrl.value.trim();
  try{new URL(u)}catch{return alert("Link không hợp lệ")}
  document.execCommand("insertHTML",false,
    `<a href="${u}" target="_blank">${t||u}</a>`
  );
  linkBox.style.display="none";
};

const genID=()=>{
  const c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let r="";
  for(let i=0;i<10;i++) r+=c[Math.floor(Math.random()*c.length)];
  return r;
};

window.saveNote=()=>{
  let c=editor.innerHTML.trim();
  if(!c) return alert("Note trống");
  let id=genID();
  localStorage.setItem("note_"+id,btoa(unescape(encodeURIComponent(c))));
  history.pushState({}, "", id);
  showLinkOut(id);
};

window.showLinkOut=id=>{
  let u=location.origin+location.pathname.replace(/\/[^\/]*$/,"/")+id;
  output.style.display="block";
  output.innerHTML=`Link chia sẻ:<br><a href="${u}">${u}</a>`;
};

window.loadNote=()=>{
  let id=location.pathname.split("/").pop();
  let n=localStorage.getItem("note_"+id);
  if(n){
    editor.innerHTML=decodeURIComponent(escape(atob(n)));
    showLinkOut(id);
  }
};

window.showRaw=()=>{
  output.style.display="block";
  output.textContent=editor.innerHTML;
};

document.addEventListener("contextmenu",e=>e.preventDefault());
document.addEventListener("keydown",e=>{
  if(e.key==="F12" || (e.ctrlKey && ["u","s","i"].includes(e.key.toLowerCase())))
    e.preventDefault();
});

loadNote();

})();
</script>
